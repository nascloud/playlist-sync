# 匹配失败原因分析 (第二轮优化后)

## 总体情况

本次测试共处理了 44 首歌曲，匹配成功数为 0，匹配成功率为 0.00%。这与第一轮测试后的预期（匹配成功率会提升）相反，表明最近的优化可能引入了问题或者测试环境/数据发生了变化。

从 `test_enhanced_matching.py` 的详细日志输出来看，问题主要出在：

1.  **核心标题搜索阶段**: 大部分歌曲的核心标题搜索返回了0个候选结果 (`核心标题 'xxx' 搜索到 0 个候选结果`)。例如 `Baby, Don't Cry（人鱼的眼泪） (Chinese Ver.)`, `你，好不好？`。
2.  **评分阶段**: 对于有候选结果的歌曲，最终评分都非常低（通常低于新的阈值 50），导致匹配失败。例如 `爱你 (青春离别版)` 最高分是 35.00，`凉凉` 最高分是 47.20。

这与之前分析文件 `enhanced_matching_analysis_output.json` 中显示的成功匹配了 18 首歌（成功率约 40.91%）的情况完全不同。

## 问题诊断

### 1. 核心标题搜索失败 (`match_score` 为 0)

这些情况表明，在 Plex 库中通过核心标题无法检索到任何音轨。

*   **`Baby, Don't Cry（人鱼的眼泪） (Chinese Ver.)`**: 核心标题提取为 `baby don t cry`。Plex API 搜索返回 0 个结果。
*   **`你，好不好？`**: 标准化后为 `你 好不好`，核心标题也是 `你 好不好`。Plex API 搜索返回 0 个结果。
*   **原因分析**:
    *   **库中确实不存在**: 这是最直接的原因。Plex 音乐库中可能没有这些歌曲。
    *   **核心标题提取错误**: 提取逻辑可能将标题切得过碎，或者移除了关键信息。
        *   例如 `Baby, Don't Cry（人鱼的眼泪） (Chinese Ver.)`，理想的核心标题可能是 `baby don't cry` 或 `baby don't cry chinese ver`。当前逻辑可能因为 `VERSION_KEYWORDS` 中没有 `ver` 的小写形式，或者括号处理逻辑，导致提取不准确。
    *   **搜索 API 问题**: Plex 的搜索功能可能对某些特殊字符或空格处理不佳。

### 2. 评分不足 (有候选但分数低)

对于有候选的歌曲，最终得分低于阈值 50。

*   **`凉凉` (杨宗纬, 张碧晨)**: 最高分候选是 `凉凉 (Artist: 杨宗纬)`，得分为 47.20。
    *   标题分: 100 (完美匹配)
    *   艺术家分: 18 (较低，因为 `张碧晨` 未匹配)
    *   专辑分: 20 (较低)
    *   最终得分: 47.20 (低于 50)
*   **`若月亮没来 (Live)` (杨宗纬, 宝石Gem, 王宇宙Leto)**: 最高分候选是 `若月亮没来 (若是月亮还没来) (Artist: 王宇宙Leto)`，得分为 41.80。
    *   标题分: 100
    *   艺术家分: 17 (匹配了 `王宇宙Leto`，但 `杨宗纬, 宝石Gem` 未匹配)
    *   专辑分: 0
    *   最终得分: 41.80
*   **`爱你 (青春离别版)` (高睿)**: 最高分候选是 `爱你 (Artist: 动力火车)`，得分为 35.00。
    *   标题分: 100
    *   艺术家分: 0 (完全不匹配)
    *   专辑分: 0
    *   最终得分: 35.00

*   **原因分析**:
    *   **艺术家评分逻辑问题**: 当前的 `_calculate_artist_score` 虽然引入了部分匹配奖励，但如果查询艺术家集合与匹配艺术家集合的交集很小或没有，最终得分仍然会很低。对于多艺术家歌曲，如果库中只存了主要艺术家，评分可能不足以达到阈值。
    *   **权重分配**: 当前权重是 标题(0.35), 艺术家(0.40), 专辑(0.25)。如果艺术家信息不完整，即使标题完全匹配，总分也可能不够。
    *   **阈值过高**: 新的阈值 High: 62, Low: 50 可能对于当前的评分体系来说还是偏高，尤其是在艺术家信息不完整的情况下。

## 优化方案建议

基于以上分析，提出以下优化建议：

1.  **重新审视核心标题提取逻辑 (`_extract_core_title`)**:
    *   **问题**: `Baby, Don't Cry` 的例子表明，`ver` 未被正确识别为版本关键词，或者括号处理导致核心标题提取不准确。
    *   **建议**:
        *   检查 `VERSION_KEYWORDS` 中 `ver` 的匹配是否区分大小写。考虑添加 `Ver` 或使用不区分大小写的匹配。
        *   重新评估 `_remove_brackets` 和 `_extract_core_title` 的顺序和逻辑。确保在移除版本关键词之前，括号内容（特别是包含版本信息的）被正确处理。
        *   增加日志，打印出每首歌的 `norm_title` 和 `core_title`，以便调试。

2.  **优化艺术家评分逻辑 (`_calculate_artist_score`)**:
    *   **问题**: 多艺术家场景下，即使匹配了主要艺术家，得分也可能不足。
    *   **建议**:
        *   **调整奖励机制**: 当前的 `max(combined_score, 60)` 是一个固定值。可以考虑根据交集大小动态调整。例如，如果匹配了至少一个主要艺术家，基础分可以设为 50 或 55。
        *   **更智能的匹配**: 对于查询艺术家 `A, B, C` 和库艺术家 `A`，可以认为这是一个“主要艺术家匹配”，给予比 `A` 和 `D` 匹配更高的分数。可以计算查询艺术家集合与匹配艺术家集合的重合度，并据此调整分数。
        *   **考虑艺术家别名**: 如果 Plex 库中艺术家有别名（如 `黄丽玲` vs `A-Lin`），需要一种机制来处理。这比较复杂，可能需要外部数据源或手动映射。

3.  **重新评估评分权重**:
    *   **问题**: 艺术家权重 (0.40) 相对较高，当艺术家信息不完整时，对总分影响大。
    *   **建议**:
        *   可以尝试略微降低艺术家权重（如 0.35），并相应提高标题权重（如 0.40），因为标题通常是识别歌曲的最可靠信息。
        *   例如：`W_TITLE = 0.40, W_ARTIST = 0.35, W_ALBUM = 0.25`。

4.  **调整阈值**:
    *   **问题**: 当前阈值可能过高。
    *   **建议**:
        *   可以先将 High 阈值调回 65，观察匹配成功率。如果仍然过低，再考虑微调。
        *   或者，可以保持 High 为 62，但将 Low 阈值降低到 45 或 40，以捕获更多边缘案例供人工审核。

## 下一步行动

1.  **修复核心标题提取**:
    *   重点检查 `Baby, Don't Cry` 和 `你，好不好？` 这两个案例，打印调试信息，确认 `norm_title` 和 `core_title` 是否正确。
    *   修改 `_extract_core_title` 以更好地处理 `ver` 和混合括号内容。
2.  **微调艺术家评分**:
    *   在 `_calculate_artist_score` 中，实现更动态的部分匹配奖励。
3.  **调整权重和阈值**:
    *   尝试将艺术家权重从 0.40 调整为 0.35，标题权重从 0.35 调整为 0.40。
    *   将 High 阈值从 62 调回 65。
4.  **重新运行测试**:
    *   应用上述修改后，再次运行 `test_enhanced_matching.py`，生成新的分析文件。
5.  **分析新结果**:
    *   比较新旧分析文件，评估各项修改的效果，特别是关注核心标题搜索成功率和最终匹配成功率的变化。