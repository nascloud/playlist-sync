# 匹配失败原因分析

## 总体情况

本次测试共处理了 44 首歌曲，其中 18 首匹配成功 (40.91%)，26 首匹配失败 (59.09%)。这与您提到的约 59% 的成功率（成功匹配/总数）有所差异，可能是因为计算口径不同或测试环境变化。我们基于分析文件 `enhanced_matching_analysis_output.json` 来分析失败原因。

## 失败原因分类

### 1. 搜索不到 (核心标题提取不当或库中确实没有)

这类问题通常表现为 `match_score` 为 0，意味着在 Plex 库中没有通过核心标题搜索到任何候选结果，或者所有候选结果的评分都低于阈值。

**典型例子:**

*   `爱你 (青春离别版)` - 高睿
    *   标准化后标题: `爱你`
    *   核心标题: `爱你`
    *   问题分析: 标准化和核心标题提取逻辑看起来合理。如果库中确实没有这首歌，或者艺术家信息不匹配（如 Plex 库中是 "Gao Rui"），就会失败。需要检查库中是否存在。
*   `放纵L` - 格雷西西西 / 怪阿姨
    *   标准化后标题: `放纵l`
    *   核心标题: `放纵l` (字母 'L' 是否被正确处理？)
    *   问题分析: 需要确认 'L' 是版本信息还是歌曲名的一部分。如果是后者，当前提取逻辑是正确的。但同样需要检查库中是否存在。
*   `죽을 만큼 아파서 (死一样的痛苦)` - MC梦 (MC몽), Mellow (멜로우)
    *   标准化后标题: `죽을 만큼 아파서 (死一样的痛苦)` (可能变为 `죽을 만큼 아파서 死一样的痛苦`)
    *   核心标题: `죽을 만큼 아파서 死一样的痛苦` (括号被移除)
    *   问题分析: 韩文和中文混合标题，标准化和核心提取可能有效。失败原因可能是库中没有这首歌，或者艺术家 "MC梦 (MC몽), Mellow (멜로우)" 与库中命名方式差异过大（如 "MC Mong"），导致评分过低。
*   `Baby, Don't Cry（人鱼的眼泪） (Chinese Ver.)` - EXO (엑소)
    *   标准化后标题: `baby dont cry人鱼的眼泪 chinese ver` (标点、括号移除)
    *   核心标题: `baby dont cry人鱼的眼泪 chinese ver` (版本关键词 "version" 未匹配 "ver")
    *   问题分析: `VERSION_KEYWORDS` 列表中没有 `ver`，导致核心标题提取不彻底。库中可能存的是 `Baby, Don't Cry` 或 `Baby, Don't Cry (Chinese Version)`。
*   `梦见春天野花开 (女版)` - 窝窝, 贝果乐团
    *   标准化后标题: `梦见春天野花开 女版`
    *   核心标题: `梦见春天野花开 女版` ( `女版` 未被识别为版本关键词)
    *   问题分析: `女版` 是一个非标准的但很常见的版本描述，当前逻辑无法识别并移除。库中可能存的是 `梦见春天野花开`。
*   `冬眠·2023` - 阿YueYue, 刘兆宇
    *   标准化后标题: `冬眠 2023` (标点移除)
    *   核心标题: `冬眠 2023`
    *   问题分析: `2023` 被保留为核心标题的一部分。库中可能存的是 `冬眠` 或 `冬眠 (2023)`。
*   `天若有情` - A-Lin
    *   标准化后标题: `天若有情`
    *   核心标题: `天若有情`
    *   问题分析: 标准化和提取逻辑合理。失败原因可能是库中没有这首歌，或者艺术家 "A-Lin" 与库中 "A Lin" 等不同名。
*   `最美的瞬间` - 小阿瑞（真瑞）
    *   标准化后标题: `最美的瞬间`
    *   核心标题: `最美的瞬间`
    *   问题分析: 标准化和提取逻辑合理。失败原因同上。
*   `你，好不好？` - Eric周兴哲
    *   标准化后标题: `你 好不好` (标点移除)
    *   核心标题: `你 好不好`
    *   问题分析: 标准化和提取逻辑合理。失败原因同上。
*   `我看过` - Zealot周星星
    *   标准化后标题: `我看过`
    *   核心标题: `我看过`
    *   问题分析: 标准化和提取逻辑合理。失败原因同上。
*   `毒药` - Zealot周星星
    *   标准化后标题: `毒药`
    *   核心标题: `毒药`
    *   问题分析: 标准化和提取逻辑合理。失败原因同上。

**结论与优化建议:**

*   **核心标题提取逻辑:** 当前的 `_extract_core_title` 逻辑依赖于硬编码的 `VERSION_KEYWORDS`。对于 `ver`、`女版`、`男版`、`Live`（虽然在列表中，但需确认大小写处理）、`Live Session` 等非标准或未包含的关键词，处理不足。
    *   **建议:** 扩展 `VERSION_KEYWORDS` 列表，包含常见的非英文缩写版本词（如 `ver`, `版本`, `版`, `女版`, `男版`, `现场版`, `录音室版` 等）。或者，采用更灵活的正则表达式来匹配版本信息，例如匹配 `(\d{4})` (年份), `(Live)`, `(Acoustic)` 等模式。

*   **艺术家匹配:** 即使标题匹配，艺术家名称的差异（如全角/半角空格, `-`, `&`, `,`, 拼音/中文混用, 别名等）也可能导致最终评分过低。
    *   **建议:** `_calculate_artist_score` 已经尝试结合 Jaccard 和 fuzz，但可以进一步优化。例如，对于包含常见分隔符（`,`, `&`, `和`, `/`）的艺术家列表，可以先拆分再进行一对一匹配，最后综合得分。

### 2. 艺术家评分不足

虽然很多失败案例也可能有搜索到候选（评分非0但低于阈值），但从分析文件看，大部分失败案例评分直接为0，这更多指向搜索或核心标题提取问题。但是，一些评分接近阈值但未达标的案例（如 `若月亮没来 (Live)` 得分 53），其失败原因很可能与艺术家评分有关。

*   `若月亮没来 (Live)` - 杨宗纬, 宝石Gem, 王宇宙Leto
    *   匹配成功项: `若月亮没来 (若是月亮还没来)` - 王宇宙Leto (得分 53)
    *   问题分析: 匹配到的艺术家是 "王宇宙Leto"，而查询艺术家是 "杨宗纬, 宝石Gem, 王宇宙Leto"。`_calculate_artist_score` 会将两者拆分成集合进行比较。
        *   查询集: `{'杨宗纬', '宝石Gem', '王宇宙Leto'}`
        *   匹配集: `{'王宇宙Leto'}`
        *   Jaccard相似度 = 1/3。结合 fuzz.ratio，最终得分可能偏低。虽然主唱匹配了，但其他艺术家缺失导致扣分。

**结论与优化建议:**

*   **艺术家评分权重与逻辑:** 当前艺术家权重为 0.45。对于多艺术家歌曲，如果库中只存了主要艺术家，当前评分逻辑会显著拉低总分。
    *   **建议:**
        1.  **调整权重:** 可以略微降低艺术家权重（例如从 0.45 降到 0.40），让标题和专辑匹配度更重要，特别是当艺术家信息不完整时。
        2.  **优化评分逻辑:** 在 `_calculate_artist_score` 中，可以引入一个“部分匹配”得分机制。例如，如果匹配到的艺术家是查询艺术家的子集（或反之），可以给予一个中等分数（如 60-70），而不是严格按集合交集比例计算。或者，可以对每个查询艺术家都与匹配艺术家进行比较，取最高分作为该艺术家的代表得分，再综合。

### 3. 同名歌曲过多导致的干扰

分析文件中没有直接体现“同名干扰”导致的失败，即多个核心标题相同但艺术家不同的歌曲。但如果库中存在大量同名歌曲，那么核心标题搜索可能会召回过多无关候选，增加精细化评分的难度和计算量。

*   例如：库中可能同时有 `爱你 - 高睿` 和 `爱你 - 王心凌`。当搜索 `爱你 (青春离别版) - 高睿` 时，两个结果都会被召回。虽然最终评分会区分，但如果评分逻辑不够精细，可能会选错。

**结论与优化建议:**

*   **评分区分度:** 当前的评分体系（标题0.35, 艺术家0.45, 专辑0.2）已经考虑了艺术家的重要性。但如果同名干扰严重，可以考虑在评分中引入额外因子，如：
    *   **发行年份:** 如果 Plex Track 对象能获取 `year` 信息，可以加入年份差异的惩罚。
    *   **流派 (Genre):** 如果可获取，可以作为辅助因子。
    *   **更细粒度的搜索:** 在核心标题搜索后，如果候选过多，可以再用原始艺术家或专辑名进行一次过滤。

## 阈值评估

当前阈值为 High: 65, Low: 45。

*   **成功匹配的最低分:** 查看分析文件，最低的成功匹配分数是 `APT.` - 50分。这表明 45 的阈值可能偏低，或者这个 50 分的匹配实际上并不准确，需要人工复核。
*   **失败匹配的最高分:** 查看分析文件，最高的失败匹配分数是 0。这说明搜索阶段就已过滤掉大部分候选。但在 `test_enhanced_matching.py` 的日志汇总中提到有低置信度匹配，这表明是有评分在 45-65 之间的。需要查看具体是哪些案例。
*   **建议:**
    *   **High 阈值 (65):** 当前可能偏高，导致一些本可以接受的匹配被拒绝。可以考虑微调到 60 或 62。
    *   **Low 阈值 (45):** 当前可能偏低。可以考虑调整到 50 或 55，以减少低质量的“低置信度”匹配，同时保留一些边缘情况供人工审核。

## 下一步优化迭代方案

综合以上分析，提出以下具体的优化方案和实施步骤：

1.  **优化核心标题提取 (`_extract_core_title`)**:
    *   **修改 `VERSION_KEYWORDS`**: 添加 `ver`, `版本`, `版`, `女版`, `男版`, `现场版`, `录音室版`, `纯音乐版`, `伴奏版` 等。
    *   **增强正则表达式**: 添加对年份 (`\b\d{4}\b`) 和常见版本描述 (`\(Live.*?\)`, `\[Acoustic.*?\]` 等) 的匹配和移除。
    *   **文件:** `backend/services/plex_service.py`

2.  **优化艺术家评分 (`_calculate_artist_score`)**:
    *   **调整权重**: 在 `_calculate_enhanced_score` 中，将 `W_ARTIST` 从 0.45 调整为 0.40。
    *   **改进评分逻辑**: 在 `_calculate_artist_score` 内部，实现“部分匹配”逻辑。例如，如果查询艺术家集合包含匹配艺术家集合（或反之），则给予一个基础奖励分（如 60）。可以设置 `if jaccard_similarity > 0.5: combined_score = max(combined_score, 65)` 这样的规则。
    *   **文件:** `backend/services/plex_service.py`

3.  **调整评分阈值 (`PlexService` 类)**:
    *   **微调 High 阈值**: 从 65 调整为 62。
    *   **微调 Low 阈值**: 从 45 调整为 50。
    *   **文件:** `backend/services/plex_service.py`

4.  **(可选) 探索引入额外区分因子**:
    *   **调研 Plex API**: 检查 `Track` 对象是否包含 `year` (发行年份) 或 `genre` (流派) 信息。
    *   **如果可用**: 可以在 `_calculate_enhanced_score` 中加入年份差异的轻微惩罚或奖励，以及流派匹配的加分项。
    *   **文件:** `backend/services/plex_service.py`

5.  **实施与测试**:
    *   **代码修改**: 根据上述方案修改 `plex_service.py`。
    *   **运行测试**: 使用 `run_enhanced_matching_test.py` 脚本重新生成 `enhanced_matching_analysis_output.json`。
    *   **分析新结果**: 对比新旧分析文件，评估各项改动的效果，特别是关注之前失败但现在成功的案例，以及是否有之前成功但现在失败的案例（可能阈值或权重调整过度）。
    *   **迭代**: 根据新分析结果，进一步微调参数或逻辑。