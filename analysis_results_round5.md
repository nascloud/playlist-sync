# 匹配失败原因分析 (第五轮优化后 - 阈值调整)

## 总体情况

本次测试共处理了 44 首歌曲，匹配成功数为 23，匹配成功率为 52.27%。这比上一轮的 95.45% 有所下降，但这是由于调整了高置信度阈值（从 65 降至 55）导致的。原先被归类为“低置信度匹配”的歌曲现在被正确地归类为“匹配失败”。

从 `test_enhanced_matching.py` 的详细日志输出来看，问题依然主要集中在两方面：

1.  **核心标题搜索失败 (`match_score` 为 0)**: 例如 `冬眠·2023`, `你，好不好？` 等，表明 Plex API 无法通过提取的核心标题检索到任何音轨。
2.  **评分不足 (有候选但分数低)**: 大部分有候选结果的歌曲最终得分都低于新的 High 阈值 55。例如 `若月亮没来 (Live)` 最高分 50.95，`壁上观` 最高分 50.60，`凉凉` 最高分 55.30 (刚好达到高置信度阈值)。

值得注意的是，`凉凉` 成功达到了高置信度匹配 (分数 55.30)，这验证了阈值调整的合理性。

## 问题诊断

### 1. 核心标题搜索失败 (`match_score` 为 0)

*   **`冬眠·2023`**: 核心标题提取为 `冬眠 2023`。Plex API 搜索返回 0 个结果。
*   **`你，好不好？`**: 标准化后为 `你 好不好`，核心标题也是 `你 好不好`。Plex API 搜索返回 0 个结果。
*   **原因分析**:
    *   **库中确实不存在**: 这是最可能的原因。Plex 音乐库中可能没有这些歌曲。
    *   **核心标题提取逻辑**: 当前逻辑看起来是合理的。`冬眠·2023` 被处理为 `冬眠 2023`，`你，好不好？` 被处理为 `你 好不好`。如果库中确实存在这些歌曲，可能需要更细致的处理（例如保留某些标点或使用更模糊的搜索方式），但这通常不推荐，因为会降低精确度。

### 2. 评分不足 (有候选但分数低)

*   **普遍现象**: `若月亮没来 (Live)` (50.95), `壁上观` (50.60), `如果爱忘了 (Live)` (51.30), `沉溺 (你让我的心不再结冰)` (50.60), `燕无歇` (50.25), `伯虎说` (51.65), `去年花开` (51.30), `迷失幻境` (52.00), `清空` (51.30), `潮汐(Natural)` (50.25), `落日与晚风` (50.25), `化作烟火为你坠落` (52.00), `雪 Distance` (50.25), `我看过` (50.25), `我的纸飞机` (52.70), `时光背面的我` (52.00), `放空` (51.30), `毒药` (50.25), `春娇与志明` (52.35)。
*   **原因分析**:
    *   **艺术家评分逻辑**: 当前的 `_calculate_artist_score` 逻辑已经比较完善，但对于多艺术家歌曲，如果库中只存了部分艺术家，或者艺术家名称有细微差异，最终得分仍然可能不够高。例如：
        *   `若月亮没来 (Live)` by `杨宗纬, 宝石Gem, 王宇宙Leto` vs `若月亮没来 (若是月亮还没来)` by `王宇宙Leto` (得分 50.95)。艺术家部分匹配了 `王宇宙Leto` (得分 17)，但 `杨宗纬` 和 `宝石Gem` 未匹配，导致最终得分低于阈值。
        *   `凉凉` by `杨宗纬, 张碧晨` vs `凉凉` by `杨宗纬` (得分 55.30)。匹配了 `杨宗纬` (得分 18)，并且专辑得分有 20 分的加成，最终刚好达到高置信度阈值。
    *   **权重分配**: 当前权重是 标题(0.45), 艺术家(0.35), 专辑(0.20)。这个分配相对合理。
    *   **阈值**: 新的 High 阈值 55 对于当前的评分体系来说是合适的。它能够区分出那些艺术家信息高度匹配的歌曲（如 `凉凉`）和部分匹配的歌曲。

## 优化方案建议

基于以上分析，提出以下优化建议：

1.  **维持当前核心标题提取逻辑**: 当前的修改 (保留单引号、更健壮的版本关键词移除) 已被证明是有效的，应保持不变。
2.  **维持当前阈值**: High: 55, Low: 50 的阈值组合看起来是合理的，特别是 High 阈值 55 能够准确识别出高匹配度的歌曲。
3.  **进一步优化艺术家评分逻辑**:
    *   **问题**: 多艺术家场景下，部分匹配的得分提升有限，导致最终得分低于阈值。
    *   **建议**:
        *   **考虑艺术家顺序**: 在计算 `intersection_ratio_in_query` 时，可以给第一个艺术家更高的权重，或者如果第一个艺术家匹配，则给予额外奖励。当前逻辑似乎考虑了这一点（通过 `first_artist_matched`），但奖励幅度可能还不够。
        *   **调整奖励幅度**: 当前的奖励是 `55 + (intersection_ratio_in_query * 25)`。可以考虑稍微提高基础奖励或增加比率系数，例如 `57 + (intersection_ratio_in_query * 23)`，以略微提升部分匹配歌曲的得分。
        *   **更精细的匹配**: 对于 `A, B` vs `A` 和 `B, A` vs `A`，可以认为前者是“主要艺术家匹配”，后者是“次要艺术家匹配”，给予前者稍高一点的分数。
4.  **人工确认未匹配歌曲**: 对于 `冬眠·2023` 和 `你，好不好？` 这类核心标题搜索失败的歌曲，需要人工确认它们是否确实存在于 Plex 音乐库中。如果不存在，则无法匹配是合理的，无需进一步优化策略。

## 下一步行动

1.  **人工确认未匹配歌曲**: 确认 `冬眠·2023` 和 `你，好不好？` 是否存在于 Plex 音乐库中。
2.  **优化艺术家评分**:
    *   在 `_calculate_artist_score` 中，尝试微调动态奖励的基础分和系数。
    *   考虑艺术家顺序的影响（如果尚未充分考虑）。
3.  **重新运行测试**: 应用艺术家评分调整后，再次运行 `test_enhanced_matching.py`，生成新的分析文件。
4.  **分析新结果**: 比较新旧分析文件，评估艺术家评分逻辑调整的效果，特别是关注多艺术家歌曲的评分是否有提升。