# 匹配失败原因分析 (第三轮优化后)

## 总体情况

本次测试共处理了 44 首歌曲，匹配成功数为 1 (`凉凉`)，匹配成功率为 2.27%。这比上一轮的 0% 有所提升，但仍然远低于预期。

从 `test_enhanced_matching.py` 的详细日志输出来看，问题依然集中在两个方面：

1.  **核心标题搜索失败 (`match_score` 为 0)**: 例如 `Baby, Don't Cry（人鱼的眼泪） (Chinese Ver.)`, `你，好不好？` 等，表明 Plex API 无法通过提取的核心标题检索到任何音轨。
2.  **评分不足 (有候选但分数低)**: 大部分有候选结果的歌曲最终得分都低于 High 阈值 65，甚至低于 Low 阈值 50。例如 `若月亮没来 (Live)` 最高分 45.95，`壁上观` 最高分 45.60。

值得注意的是，`凉凉` 成功匹配，得分为 51，介于 High (65) 和 Low (50) 阈值之间。这表明 Low 阈值 50 是一个合理的下限，可以捕获一些边缘匹配。

## 问题诊断

### 1. 核心标题搜索失败 (`match_score` 为 0)

*   **`Baby, Don't Cry（人鱼的眼泪） (Chinese Ver.)`**: 核心标题提取为 `baby don t cry`。Plex API 搜索返回 0 个结果。
*   **`你，好不好？`**: 标准化后为 `你 好不好`，核心标题也是 `你 好不好`。Plex API 搜索返回 0 个结果。
*   **原因分析**:
    *   **库中确实不存在**: 这是最可能的原因。Plex 音乐库中可能没有这些歌曲。
    *   **核心标题提取逻辑**: 提取逻辑可能将标题切得过碎，或者移除了关键信息。
        *   例如 `Baby, Don't Cry（人鱼的眼泪） (Chinese Ver.)`，理想的核心标题可能是 `baby don't cry` 或 `baby don't cry chinese ver`。当前 `VERSION_KEYWORDS` 包含了 `ver` 和 `Ver`，并且 `_extract_core_title` 也进行了处理，但结果仍为 `baby don t cry`。这表明 `re.sub(rf"\b{re.escape(keyword)}\b", "", core_title, flags=re.IGNORECASE)` 可能未能正确匹配 `Ver.` (带点)。
    *   **搜索 API 问题**: Plex 的搜索功能可能对某些特殊字符或空格处理不佳。

### 2. 评分不足 (有候选但分数低)

*   **`若月亮没来 (Live)` (杨宗纬, 宝石Gem, 王宇宙Leto)**: 最高分候选是 `若月亮没来 (若是月亮还没来) (Artist: 王宇宙Leto)`，得分为 45.95。
    *   标题分: 100 (完美匹配)
    *   艺术家分: 17 (匹配了 `王宇宙Leto`，但 `杨宗纬, 宝石Gem` 未匹配)
    *   专辑分: 0
    *   最终得分: 45.95 (低于 50)
*   **`壁上观` (一棵小葱, 张曦匀)**: 最高分候选是 `壁上观 (Artist: 张曦匀)`，得分为 45.60。
    *   标题分: 100
    *   艺术家分: 16 (匹配了 `张曦匀`，但 `一棵小葱` 未匹配)
    *   专辑分: 0
    *   最终得分: 45.60 (低于 50)
*   **`凉凉` (杨宗纬, 张碧晨)**: 最高分候选是 `凉凉 (Artist: 杨宗纬)`，得分为 51.30。
    *   标题分: 100
    *   艺术家分: 18 (匹配了 `杨宗纬`，`张碧晨` 未匹配)
    *   专辑分: 20
    *   最终得分: 51.30 (高于 50，被识别为低置信度匹配)
*   **原因分析**:
    *   **艺术家评分逻辑**: 当前的 `_calculate_artist_score` 虽然引入了动态部分匹配奖励，但对于多艺术家歌曲，如果库中只存了部分艺术家，最终得分仍然可能不够高。特别是当未匹配的艺术家在查询列表中排在前面时（如 `杨宗纬, 张碧晨` vs `杨宗纬`），可能感觉信息丢失较多。
    *   **权重分配**: 当前权重是 标题(0.40), 艺术家(0.35), 专辑(0.25)。这个分配相对合理，但当艺术家信息不完整时，仍然会对总分产生显著影响。
    *   **阈值**: High 阈值 65 对于当前的评分体系，尤其是多艺术家场景，可能仍然偏高。`凉凉` 的成功（51分）表明 Low 阈值 50 是有效的。

## 优化方案建议

基于以上分析，提出以下优化建议：

1.  **进一步优化核心标题提取逻辑 (`_extract_core_title`)**:
    *   **问题**: `Baby, Don't Cry` 的例子表明，`Ver.` (带点) 可能未被 `ver` 完全匹配。
    *   **建议**:
        *   在 `VERSION_KEYWORDS` 中添加 `Ver.`。
        *   或者，在正则表达式中使用更宽松的模式，例如 `ver\.?` 来匹配 `ver` 和 `ver.`。
        *   **验证**: 需要打印 `Baby, Don't Cry` 的 `norm_title` 和 `core_title`，确认问题点。

2.  **微调艺术家评分逻辑 (`_calculate_artist_score`)**:
    *   **问题**: 多艺术家场景下，部分匹配的得分提升有限。
    *   **建议**:
        *   **考虑艺术家顺序**: 在计算 `intersection_ratio_in_query` 时，可以给第一个艺术家更高的权重，或者如果第一个艺术家匹配，则给予额外奖励。
        *   **调整奖励幅度**: 当前的奖励是 `50 + (intersection_ratio_in_query * 20)`。可以考虑提高基础奖励或增加比率系数，例如 `55 + (intersection_ratio_in_query * 25)`。
        *   **更精细的匹配**: 对于 `A, B` vs `A` 和 `B, A` vs `A`，可以认为前者是“主要艺术家匹配”，后者是“次要艺术家匹配”，给予前者稍高一点的分数。

3.  **保持当前权重和阈值**:
    *   当前的权重分配和 High: 65, Low: 50 的阈值组合看起来是经过深思熟虑的。`凉凉` 的成功匹配证明了 Low 阈值的有效性。
    *   可以暂时不调整，观察后续效果。如果匹配率仍然很低，再考虑微调 High 阈值到 60-62 之间。

## 下一步行动

1.  **修复核心标题提取**:
    *   重点检查 `Baby, Don't Cry`，打印调试信息，确认 `norm_title` 和 `core_title`。
    *   修改 `VERSION_KEYWORDS` 或 `_extract_core_title` 的正则表达式，以更好地处理 `Ver.`。
2.  **优化艺术家评分**:
    *   在 `_calculate_artist_score` 中，尝试提高动态奖励的基础分和系数。
    *   考虑艺术家顺序的影响。
3.  **重新运行测试**:
    *   应用上述修改后，再次运行 `test_enhanced_matching.py`，生成新的分析文件。
4.  **分析新结果**:
    *   比较新旧分析文件，评估各项修改的效果，特别是关注 `Baby, Don't Cry` 是否能被搜索到，以及其他多艺术家歌曲的评分是否有提升。